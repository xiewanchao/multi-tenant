<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>接口访问测试面板</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ink: #1a1a1a;
      --cream: #f5f0e8;
      --warm: #c8a96e;
      --warm-dark: #9e7c45;
      --gray: #888;
      --border: #ddd5c5;
      --green: #2d6a4f;
      --green-bg: #eaf4ee;
      --red: #7b2d2d;
      --red-bg: #f9eaea;
      --blue: #2c4a7b;
      --blue-bg: #eaf0fb;
      --orange: #7a4a10;
      --orange-bg: #fdf3e3;
    }

    body {
      min-height: 100vh;
      font-family: 'DM Sans', sans-serif;
      background: var(--cream);
      color: var(--ink);
    }

    /* ── Topbar ── */
    .topbar {
      background: var(--ink);
      padding: 0 2.5rem;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-logo {
      font-family: 'Playfair Display', serif;
      color: #fff;
      font-size: 1.1rem;
      letter-spacing: 0.04em;
    }

    .topbar-logo span { color: var(--warm); }

    .topbar-user {
      display: flex;
      align-items: center;
      gap: 1.2rem;
    }

    .token-badge {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      background: rgba(200,169,110,0.15);
      color: var(--warm);
      border: 1px solid rgba(200,169,110,0.3);
      padding: 0.25rem 0.75rem;
      border-radius: 2px;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-logout {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      background: none;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 0.3rem 0.9rem;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }
    .btn-logout:hover { color: #fff; border-color: rgba(255,255,255,0.5); }

    /* ── Main layout ── */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2.5rem 2rem 4rem;
    }

    .page-header {
      margin-bottom: 2.5rem;
      border-bottom: 1.5px solid var(--border);
      padding-bottom: 1.5rem;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .page-header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 1.75rem;
      line-height: 1.2;
    }

    .page-header p {
      font-size: 0.82rem;
      color: var(--gray);
      margin-top: 0.3rem;
    }

    .summary-bar {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .summary-pill {
      font-size: 0.72rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 0.3rem 0.9rem;
      border-radius: 2px;
    }
    .pill-total  { background: var(--ink); color: #fff; }
    .pill-ok     { background: var(--green-bg); color: var(--green); }
    .pill-fail   { background: var(--red-bg); color: var(--red); }
    .pill-skip   { background: #f0f0f0; color: var(--gray); }

    /* ── Controls ── */
    .controls {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn-run-all {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      background: var(--ink);
      color: #fff;
      border: none;
      padding: 0.6rem 1.4rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-run-all:hover { background: var(--warm-dark); }

    .btn-clear {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: none;
      color: var(--gray);
      border: 1.5px solid var(--border);
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .btn-clear:hover { border-color: var(--ink); color: var(--ink); }

    .token-toggle {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.78rem;
      color: var(--gray);
    }

    /* toggle switch */
    .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; inset: 0;
      background: #ccc; border-radius: 20px;
      cursor: pointer; transition: background 0.2s;
    }
    .slider::before {
      content: '';
      position: absolute;
      width: 14px; height: 14px;
      left: 3px; top: 3px;
      background: #fff; border-radius: 50%;
      transition: transform 0.2s;
    }
    .switch input:checked + .slider { background: var(--warm-dark); }
    .switch input:checked + .slider::before { transform: translateX(16px); }

    /* ── Link list ── */
    .link-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      border: 1.5px solid var(--border);
      background: #fff;
    }

    .link-row {
      display: grid;
      grid-template-columns: 32px 1fr auto auto;
      align-items: center;
      gap: 0 1rem;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    .link-row:last-child { border-bottom: none; }
    .link-row:hover { background: #fafaf7; }

    .row-index {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      color: var(--border);
      text-align: center;
    }

    .row-main { min-width: 0; }

    .row-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--ink);
      margin-bottom: 0.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tag {
      font-size: 0.62rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 0.1rem 0.5rem;
      border-radius: 2px;
    }
    .tag-get    { background: var(--blue-bg);   color: var(--blue); }
    .tag-post   { background: var(--orange-bg); color: var(--orange); }
    .tag-delete { background: var(--red-bg);    color: var(--red); }
    .tag-auth   { background: var(--green-bg);  color: var(--green); }
    .tag-open   { background: #f0f0f0;          color: var(--gray); }

    .row-url {
      font-family: 'DM Mono', monospace;
      font-size: 0.72rem;
      color: var(--gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 440px;
    }

    .row-expect {
      font-size: 0.72rem;
      color: var(--gray);
      white-space: nowrap;
    }

    .row-actions {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
      transition: background 0.3s;
    }
    .status-dot.pending  { background: var(--border); }
    .status-dot.loading  { background: var(--warm); animation: pulse 0.8s infinite; }
    .status-dot.ok       { background: #3a9e6a; }
    .status-dot.fail     { background: #c0392b; }
    .status-dot.warn     { background: #e67e22; }

    @keyframes pulse {
      0%,100% { opacity: 1; } 50% { opacity: 0.3; }
    }

    .result-chip {
      font-family: 'DM Mono', monospace;
      font-size: 0.7rem;
      font-weight: 500;
      padding: 0.2rem 0.55rem;
      border-radius: 2px;
      min-width: 60px;
      text-align: center;
      transition: all 0.25s;
    }
    .chip-idle   { background: #f0f0f0; color: #bbb; }
    .chip-ok     { background: var(--green-bg); color: var(--green); }
    .chip-fail   { background: var(--red-bg);   color: var(--red); }
    .chip-warn   { background: var(--orange-bg);color: var(--orange); }

    .btn-test {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.72rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: none;
      border: 1px solid var(--border);
      color: var(--gray);
      padding: 0.3rem 0.75rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
      white-space: nowrap;
    }
    .btn-test:hover { border-color: var(--warm); color: var(--warm-dark); }

    /* ── Detail drawer ── */
    .detail-row {
      display: none;
      background: #fafaf7;
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.25rem 1rem 3.25rem;
    }
    .detail-row.open { display: block; }

    .detail-pre {
      font-family: 'DM Mono', monospace;
      font-size: 0.72rem;
      line-height: 1.7;
      color: #555;
      white-space: pre-wrap;
      word-break: break-all;
      background: #fff;
      border: 1px solid var(--border);
      padding: 0.75rem 1rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .detail-meta {
      display: flex;
      gap: 1.5rem;
      font-size: 0.72rem;
      color: var(--gray);
      margin-top: 0.6rem;
    }
    .detail-meta strong { color: var(--ink); }

    /* ── Toast ── */
    .toast {
      position: fixed; bottom: 2rem; left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: var(--ink); color: #fff;
      padding: 0.65rem 1.4rem;
      font-size: 0.8rem; border-radius: 2px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      z-index: 999;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-logo">接口测试 <span>·</span> Dashboard</div>
    <div class="topbar-user">
      <div class="token-badge" id="tokenDisplay">未检测到 Token</div>
      <button class="btn-logout" onclick="logout()">退出登录</button>
    </div>
  </header>

  <div class="container">

    <!-- Page header -->
    <div class="page-header">
      <div>
        <h1>超链接访问测试</h1>
        <p>携带 Token 对各接口发起请求，验证授权策略是否符合预期</p>
      </div>
      <div class="summary-bar">
        <div class="summary-pill pill-total" id="s-total">共 0 条</div>
        <div class="summary-pill pill-ok"    id="s-ok">✓ 0 通过</div>
        <div class="summary-pill pill-fail"  id="s-fail">✗ 0 失败</div>
        <div class="summary-pill pill-skip"  id="s-skip">— 0 跳过</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="btn-run-all" onclick="runAll()">▶ 全部测试</button>
      <button class="btn-clear"   onclick="clearAll()">重置结果</button>
      <label class="token-toggle">
        <label class="switch">
          <input type="checkbox" id="tokenSwitch" checked onchange="updateTokenLabel()">
          <span class="slider"></span>
        </label>
        <span id="tokenSwitchLabel">携带 Token</span>
      </label>
    </div>

    <!-- Link list -->
    <div class="link-list" id="linkList"></div>

  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ══════════════════════════════════════════════════════
    //  配置：在此处添加/修改要测试的超链接
    // ══════════════════════════════════════════════════════
    const LINKS = [
      {
        label:    '获取当前用户信息',
        url:      'https://jsonplaceholder.typicode.com/users/1',
        method:   'GET',
        authRequired: true,           // 预期：需要鉴权
        expectStatus: 200,            // 预期 HTTP 状态码
        note:     '应返回 200，Token 有效时允许访问',
      },
      {
        label:    '获取文章列表',
        url:      'https://jsonplaceholder.typicode.com/posts',
        method:   'GET',
        authRequired: false,          // 预期：公开接口
        expectStatus: 200,
        note:     '公开接口，无论是否携带 Token 均应返回 200',
      },
      {
        label:    '创建新文章（POST）',
        url:      'https://jsonplaceholder.typicode.com/posts',
        method:   'POST',
        body:     { title: 'Test', body: 'Hello', userId: 1 },
        authRequired: true,
        expectStatus: 201,
        note:     '需鉴权，预期返回 201 Created',
      },
      {
        label:    '受保护资源（模拟 401）',
        url:      'https://httpstat.us/401',
        method:   'GET',
        authRequired: true,
        expectStatus: 401,            // 无 Token 时预期 401
        note:     '无 Token 时应被拒绝（401）；携带 Token 时模拟通过',
        mockPassWithToken: true,      // 演示：有 Token 时 Mock 为通过
      },
      {
        label:    '禁止访问资源（模拟 403）',
        url:      'https://httpstat.us/403',
        method:   'GET',
        authRequired: true,
        expectStatus: 403,
        note:     '权限不足，即使携带 Token 也应返回 403',
        alwaysForbidden: true,        // 演示：无论如何都 403
      },
      {
        label:    '服务不存在（404）',
        url:      'https://jsonplaceholder.typicode.com/users/99999',
        method:   'GET',
        authRequired: false,
        expectStatus: 404,
        note:     '资源不存在，预期 404',
      },
      {
        label:    '删除资源（DELETE）',
        url:      'https://jsonplaceholder.typicode.com/posts/1',
        method:   'DELETE',
        authRequired: true,
        expectStatus: 200,
        note:     '需鉴权才可删除，预期 200',
      },
    ];

    // ══════════════════════════════════════════════════════
    //  初始化
    // ══════════════════════════════════════════════════════
    let token = sessionStorage.getItem('token') || localStorage.getItem('token') || '';
    let user  = {};
    try { user = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || '{}'); } catch(_) {}

    // 若无 token，仍允许进入（方便直接测试 dashboard.html）
    document.getElementById('tokenDisplay').textContent = token
      ? `Token: ${token.slice(0, 28)}…`
      : '无 Token（未登录状态）';

    // 渲染列表
    const list = document.getElementById('linkList');
    LINKS.forEach((link, i) => {
      const row = document.createElement('div');
      row.id = `row-${i}`;
      row.innerHTML = rowHTML(link, i);
      list.appendChild(row);
    });

    updateSummary();

    function rowHTML(link, i) {
      const methodTag = `<span class="tag tag-${link.method.toLowerCase()}">${link.method}</span>`;
      const authTag   = link.authRequired
        ? `<span class="tag tag-auth">需鉴权</span>`
        : `<span class="tag tag-open">公开</span>`;
      return `
        <div class="link-row" id="link-row-${i}">
          <div class="row-index">${String(i+1).padStart(2,'0')}</div>
          <div class="row-main">
            <div class="row-label">${link.label} ${methodTag} ${authTag}</div>
            <div class="row-url">${link.url}</div>
          </div>
          <div class="row-expect">期望 ${link.expectStatus}</div>
          <div class="row-actions">
            <div class="status-dot pending" id="dot-${i}"></div>
            <div class="result-chip chip-idle" id="chip-${i}">—</div>
            <button class="btn-test" onclick="runOne(${i})">测试</button>
          </div>
        </div>
        <div class="detail-row" id="detail-${i}">
          <div class="detail-pre" id="pre-${i}">尚未测试</div>
          <div class="detail-meta" id="meta-${i}"></div>
        </div>`;
    }

    // ══════════════════════════════════════════════════════
    //  测试单条
    // ══════════════════════════════════════════════════════
    async function runOne(i) {
      const link      = LINKS[i];
      const useToken  = document.getElementById('tokenSwitch').checked;
      const dot       = document.getElementById(`dot-${i}`);
      const chip      = document.getElementById(`chip-${i}`);
      const pre       = document.getElementById(`pre-${i}`);
      const meta      = document.getElementById(`meta-${i}`);
      const detailRow = document.getElementById(`detail-${i}`);

      // 展开详情
      detailRow.classList.add('open');

      // Loading 状态
      dot.className  = 'status-dot loading';
      chip.className = 'result-chip chip-idle';
      chip.textContent = '…';
      pre.textContent  = '请求中...';
      meta.innerHTML   = '';

      const t0 = Date.now();

      try {
        // ── Mock 特殊场景 ────────────────────────────────
        if (link.alwaysForbidden) {
          await delay(400);
          const elapsed = Date.now() - t0;
          const passed = link.expectStatus === 403;
          setResult(i, passed, 403, '模拟：权限不足，始终 403', elapsed, link);
          updateSummary();
          return;
        }

        if (link.mockPassWithToken) {
          await delay(500);
          const elapsed = Date.now() - t0;
          if (useToken && token) {
            // 有 Token → 模拟通过
            const passed = link.expectStatus !== 401; // 期望不是 401 才算 pass
            setResult(i, true, 200, '携带 Token，模拟授权通过 (200)', elapsed, link);
          } else {
            // 无 Token → 401
            const passed = link.expectStatus === 401;
            setResult(i, passed, 401, '未携带 Token，被拒绝 (401)', elapsed, link);
          }
          updateSummary();
          return;
        }

        // ── 真实请求 ─────────────────────────────────────
        const headers = { 'Content-Type': 'application/json' };
        if (useToken && token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const fetchOpts = { method: link.method, headers };
        if (link.body) fetchOpts.body = JSON.stringify(link.body);

        const res     = await fetch(link.url, fetchOpts);
        const elapsed = Date.now() - t0;
        let body = '';
        try { body = await res.text(); } catch(_) {}

        // 尝试美化 JSON
        let display = body;
        try { display = JSON.stringify(JSON.parse(body), null, 2); } catch(_) {}

        const passed = res.status === link.expectStatus;
        setResult(i, passed, res.status, display, elapsed, link);

      } catch(err) {
        const elapsed = Date.now() - t0;
        setResult(i, false, 'ERR', `请求失败：${err.message}\n\n可能原因：CORS 限制、网络错误、接口不存在`, elapsed, link);
      }

      updateSummary();
    }

    function setResult(i, passed, status, body, elapsed, link) {
      const dot  = document.getElementById(`dot-${i}`);
      const chip = document.getElementById(`chip-${i}`);
      const pre  = document.getElementById(`pre-${i}`);
      const meta = document.getElementById(`meta-${i}`);
      const row  = document.getElementById(`link-row-${i}`);

      // 判断是否符合预期
      const statusMatch = status === link.expectStatus;

      if (passed) {
        dot.className  = 'status-dot ok';
        chip.className = 'result-chip chip-ok';
        chip.textContent = `✓ ${status}`;
        row.style.background = '#f0faf5';
      } else if (status === link.expectStatus) {
        // 状态匹配但逻辑标记为 warn
        dot.className  = 'status-dot warn';
        chip.className = 'result-chip chip-warn';
        chip.textContent = `~ ${status}`;
        row.style.background = '#fdf8f0';
      } else {
        dot.className  = 'status-dot fail';
        chip.className = 'result-chip chip-fail';
        chip.textContent = `✗ ${status}`;
        row.style.background = '#fdf0f0';
      }

      pre.textContent = body || '（无响应体）';
      meta.innerHTML  = `
        <span>耗时 <strong>${elapsed} ms</strong></span>
        <span>返回状态 <strong>${status}</strong></span>
        <span>期望状态 <strong>${link.expectStatus}</strong></span>
        <span>结果 <strong>${passed ? '✓ 符合预期' : '✗ 不符预期'}</strong></span>`;
    }

    // ══════════════════════════════════════════════════════
    //  批量运行
    // ══════════════════════════════════════════════════════
    async function runAll() {
      for (let i = 0; i < LINKS.length; i++) {
        await runOne(i);
        await delay(150);
      }
      showToast('全部测试完成');
    }

    function clearAll() {
      LINKS.forEach((_, i) => {
        document.getElementById(`dot-${i}`).className    = 'status-dot pending';
        document.getElementById(`chip-${i}`).className   = 'result-chip chip-idle';
        document.getElementById(`chip-${i}`).textContent = '—';
        document.getElementById(`pre-${i}`).textContent  = '尚未测试';
        document.getElementById(`meta-${i}`).innerHTML   = '';
        document.getElementById(`detail-${i}`).classList.remove('open');
        const r = document.getElementById(`link-row-${i}`);
        r.style.background = '';
      });
      updateSummary();
    }

    // ══════════════════════════════════════════════════════
    //  Summary bar
    // ══════════════════════════════════════════════════════
    function updateSummary() {
      const chips = LINKS.map((_, i) => document.getElementById(`chip-${i}`).textContent);
      const ok   = chips.filter(t => t.startsWith('✓')).length;
      const fail = chips.filter(t => t.startsWith('✗')).length;
      const skip = chips.filter(t => t === '—' || t === '…').length;
      document.getElementById('s-total').textContent = `共 ${LINKS.length} 条`;
      document.getElementById('s-ok').textContent    = `✓ ${ok} 通过`;
      document.getElementById('s-fail').textContent  = `✗ ${fail} 失败`;
      document.getElementById('s-skip').textContent  = `— ${skip} 待测`;
    }

    function updateTokenLabel() {
      const on = document.getElementById('tokenSwitch').checked;
      document.getElementById('tokenSwitchLabel').textContent = on ? '携带 Token' : '不携带 Token';
    }

    function logout() {
      sessionStorage.clear(); localStorage.removeItem('token'); localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(el._t);
      el._t = setTimeout(() => el.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>